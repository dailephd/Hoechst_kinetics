---
title: "Kinetics of HT degradation"
output: html_notebook
---
```{r}
library(plyr)
library(tidyverse)
library(dplyr)
library(data.table)
library(ggplot2)
library(stats)
library(sparklyr)
library(readxl)
library(plotly)
library(openxlsx)
library(gridExtra)
library(ggprism)
library(scales)
library(emojifont)
library(Cairo)
library(ggnewscale)
library(stats)
library(tidymodels)
library(patchwork)
library(formula.tools)
```
```{r}
#Links to csv files
url1 <- "https://www.dropbox.com/s/ic053m6xixmag5t/HT_degradation_demo.csv?dl=1"
url2 <- "https://www.dropbox.com/s/di568r38yhduavw/HT_accumulation_demo.csv?dl=1"
url3 <- "https://www.dropbox.com/s/lbgizq7mn0hqha1/ClusterHT.csv?dl=1"
url4 <- "https://www.dropbox.com/s/9vi4fj7h97ugzk7/20211127_H342_degradation_snapshot_old.csv?dl=1"
url5 <- "https://www.dropbox.com/s/hn53irhedktloyg/20211208_H33342_degradation_timelapse_transfer_from_old.csv?dl=1"
# Read and parse to dataframe
df_deg <- fread(url1) # Data for degradation
df_deg.old <- fread(url4)
df_acc <- fread(url2)
df_degt <-fread(url5)
# Data for accumulation
# Check available columns
colnames(df_deg)
colnames(df_acc)
knitr::opts_chunk$set(fig.width=14,fig.height = 20)


```
```{r}
df1 <- subset(df_acc ,select = c( Genotype,
                                  HT_Conc_uM,
                                  Repeat,
                                  Time_m,
                                  normed_intensity_ch2
))
df2 <- subset(df_deg, select = c( Genotype,
                                  HT_Conc_uM,
                                  Repeat,
                                  Time_m,
                                  normed_intensity_ch2 ))
df3 <- subset(df_deg.old , select =c( Genotype,
                                      HT_Conc_uM,
                                      Repeat,
                                      Time_m,
                                      normed_intensity_ch2 ) )
# Remove time -1 (background measurements)
df_acc <- df_acc[order(df_acc$HT_Conc_uM,df_acc$Time_m),]
df_deg <- df_deg[order(df_deg$HT_Conc_uM,df_deg$Time_m),]
df_deg.old <- df_deg.old[order(df_deg.old$HT_Conc_uM,df_deg.old$Time_m),]
df_acc.WT <- df1[((df1$Time_m > 0) &
  (df1$Genotype == "WT")&
  (df1$Repeat == 1)),]
df_acc.WT <- df_acc.WT[order(df_acc.WT$HT_Conc_uM,df_acc.WT$Time_m),]
df_acc.DTolC <- df1[((df1$Time_m > 0) &
  (df1$Genotype == "DTolC") &
  (df1$Repeat == 1)),]
df_acc.DTolC <- df_acc.DTolC [order(df_acc.DTolC$HT_Conc_uM,df_acc.DTolC$Time_m),]
df_deg.WT <- df2[((df2$Time_m >= 0) &
  (df2$Genotype == "WT") &
  (df2$Repeat == 1)),]
df_deg.WT <- df_deg.WT[order(df_deg.WT$HT_Conc_uM,df_deg.WT$Time_m),]
df_deg.DTolC <- df3[((df3$Time_m >= 0) &
  (df3$Genotype == "DTolC") &
  (df3$Repeat == 1)),]
df_deg.DTolC <- df_deg.DTolC[order(df_deg.DTolC$HT_Conc_uM,df_deg.DTolC$Time_m),]
```
```{r}
# Create vectors to store the results of clustering
df_acc.WT.H_pred <- c()
df_acc.WT.htconc <- unique(df_acc.WT$HT_Conc_uM)
df_deg.WT.H_pred <- c()
df_deg.WT.htconc <- unique(df_deg.WT$HT_Conc_uM)
# Loop through all the concentrations
for (i in seq_along(df_acc.WT.htconc)){
  # filter for data
  data <- df_acc.WT[df_acc.WT$HT_Conc_uM == df_acc.WT.htconc[i],]
  # calculate dissimilarity matrix from data then create hclust object on dissimilarity
  # matrix with method = "average"
  hclust <- data$normed_intensity_ch2 %>%
    dist()%>%
    hclust(method = "complete")
  # use cutree to cut hclust object into 2 clusters
  cut_avg <- cutree(hclust, k = 2)
  # append classification results to H_pred
  df_acc.WT.H_pred <- append(df_acc.WT.H_pred, cut_avg)
}
df_acc.WT$H_label <- df_acc.WT.H_pred
# Loop through all the concentrations
for (i in seq_along(df_deg.WT.htconc)){
  # filter for data
  data <- df_deg.WT[df_deg.WT$HT_Conc_uM == df_deg.WT.htconc[i],]
  # calculate dissimilarity matrix from data then create hclust object on dissimilarity
  # matrix with method = "average"
  hclust <- data$normed_intensity_ch2 %>%
    dist()%>%
    hclust(method = "complete")
  # use cutree to cut hclust object into 2 clusters
  cut_avg <- cutree(hclust, k = 2)
  # append classification results to H_pred
  df_deg.WT.H_pred<- append(df_deg.WT.H_pred, cut_avg)

}
df_deg.WT$H_label <- df_deg.WT.H_pred
```
```{r}
# Replace 1 with "bright" and 2 with "dark" in H_labels columns at concentrations 3,10,15 uM
df_deg.WT$H_label[(df_deg.WT$H_label == 1) &
                          (df_deg.WT$HT_Conc_uM == 10|
                                  df_deg.WT$HT_Conc_uM == 15)] <- "bright"
df_deg.WT$H_label[df_deg.WT$H_label == 2 &
                          (df_deg.WT$HT_Conc_uM == 10|
                                  df_deg.WT$HT_Conc_uM == 15)] <- "dark"
# Replace 1 with "dark" and 2 with "bright" in H_labels columns at concentrations 0.5,1,20 uM
df_deg.WT$H_label[(df_deg.WT$H_label == 2) &
                          (df_deg.WT$HT_Conc_uM == 0.5 |
                                  df_deg.WT$HT_Conc_uM == 1   |
                                  df_deg.WT$HT_Conc_uM == 3 |
                                  df_deg.WT$HT_Conc_uM == 20)] <- "bright"
df_deg.WT$H_label[df_deg.WT$H_label == 1 &
                          (df_deg.WT$HT_Conc_uM == 0.5 |
                                  df_deg.WT$HT_Conc_uM == 1   |
                                  df_deg.WT$HT_Conc_uM == 3 |
                                  df_deg.WT$HT_Conc_uM == 20)]   <- "dark"
```
```{r}
df_acc.WT$H_label[(df_acc.WT$H_label == 1)&
                          (df_acc.WT$HT_Conc_uM != 0.05)] <- "dark"
df_acc.WT$H_label[(df_acc.WT$H_label == 2)&
                          (df_acc.WT$HT_Conc_uM != 0.05)] <- "bright"
df_acc.WT$H_label[(df_acc.WT$H_label == 1)&
                          (df_acc.WT$HT_Conc_uM == 0.05)] <- "bright"
df_acc.WT$H_label[(df_acc.WT$H_label == 2)&
                          (df_acc.WT$HT_Conc_uM == 0.05)] <- "dark"

```
```{r}
# Create vectors to store the results of clustering
df_acc.DTolC.H_pred <- c()
df_acc.DTolC.htconc <- unique(df_acc.DTolC$HT_Conc_uM)
df_deg.DTolC.H_pred <- c()
df_deg.DTolC.htconc <- unique(df_deg.DTolC$HT_Conc_uM)
# Loop through all the concentrations
for (i in seq_along(df_acc.DTolC.htconc)){
  # filter for data
  data <- df_acc.DTolC[df_acc.DTolC$HT_Conc_uM == df_acc.DTolC.htconc[i],]
  # calculate dissimilarity matrix from data then create hclust object on dissimilarity
  # matrix with method = "average"
  hclust <- data$normed_intensity_ch2 %>%
          dist()%>%
          hclust(method = "complete")
  # use cutree to cut hclust object into 2 clusters
  cut_avg <- cutree(hclust, k = 2)
  # append classification results to H_pred
  df_acc.DTolC.H_pred <- append(df_acc.DTolC.H_pred, cut_avg)
}
df_acc.DTolC$H_label <- df_acc.DTolC.H_pred
# Loop through all the concentrations
for (i in seq_along(df_deg.DTolC.htconc)){
  # filter for data
  data <- df_deg.DTolC[df_deg.DTolC$HT_Conc_uM == df_deg.DTolC.htconc[i],]
  # calculate dissimilarity matrix from data then create hclust object on dissimilarity
  # matrix with method = "average"
  hclust <- data$normed_intensity_ch2 %>%
          dist()%>%
          hclust(method = "complete")
  # use cutree to cut hclust object into 2 clusters
  cut_avg <- cutree(hclust, k = 2)
  # append classification results to H_pred
  df_deg.DTolC.H_pred<- append(df_deg.DTolC.H_pred, cut_avg)

}
df_deg.DTolC$H_label <- df_deg.DTolC.H_pred
```
```{r}
df_acc.DTolC$H_label[(df_acc.DTolC$H_label == 1)] <- "dark"
df_acc.DTolC$H_label[(df_acc.DTolC$H_label == 2)] <- "bright"

```
```{r}
df_deg.DTolC$H_label[(df_deg.DTolC$H_label == 1)&
                             (df_deg.DTolC$HT_Conc_uM != 0.3)] <- "dark"
df_deg.DTolC$H_label[(df_deg.DTolC$H_label == 2)&
                             (df_deg.DTolC$HT_Conc_uM != 0.3)] <- "bright"
df_deg.DTolC$H_label[(df_deg.DTolC$H_label == 1)&
                             (df_deg.DTolC$HT_Conc_uM == 0.3)] <- "bright"
df_deg.DTolC$H_label[(df_deg.DTolC$H_label == 2)&
                             (df_deg.DTolC$HT_Conc_uM == 0.3)] <- "dark"
```
Calculate mean and standard deviation for each concentration at each time point
```{r}
df_deg.WT$"ln_int" <- log(df_deg.WT$normed_intensity_ch2)
df_deg.WT$"1/int" <-1/df_deg.WT$normed_intensity_ch2
```

```{r}
df_deg.WT.agg <- df_deg.WT  %>% group_by( HT_Conc_uM , Time_m ) %>%
        summarise(avg_int = mean(normed_intensity_ch2) ,
                  std_int = sd(normed_intensity_ch2),
                  med_int = median(normed_intensity_ch2))%>%
        mutate( ln_int  = log(avg_int),
                rat_int = 1/(avg_int),
                minht    = avg_int - std_int,
                maxht    = avg_int + std_int)
```
Aggregate data for each phenotype
```{r}
df_deg.WT.agg2 <- df_deg.WT  %>% group_by( HT_Conc_uM , Time_m,H_label ) %>%
        summarise(avg_int = mean(normed_intensity_ch2) ,
                  std_int = sd(normed_intensity_ch2),
                  med_int = median(normed_intensity_ch2))%>%
        mutate( ln_int  = log(avg_int),
                rat_int = 1/(avg_int),
                minht    = avg_int - std_int,
                maxht    = avg_int + std_int)
```
Plot average of HT intensity as a function of time

```{r}
# Function for point plot 
pointplot <-function(df,x,y,color,shape,title,xtitle,ytitle){
  p<-ggplot (df, aes(x, y)) +
        ggnewscale :: new_scale_colour() +
        geom_point(aes(color = as.factor(color),
                       shape = shape),
                   size = 3,
                   stroke = 1.5) +
        scale_color_prism(palette = "prism_dark") +
        labs(title = title ) +
        scale_x_continuous(name = xtitle,
                           guide = 'prism_offset_minor' ,
                           position = "bottom",
                           limits = c(-2.5,12.5),
                           expand = c(0,0)) +
        scale_y_continuous(name = ytitle,
                           guide = "prism_offset_minor"
                           ) +
        theme_prism(palette = "prism_dark" ,base_size = 14)
  return(p)
}
```
```{r}
df_deg.WT.agg.sub <- df_deg.WT.agg[df_deg.WT.agg$Time_m <= 10,]
p1 <- pointplot(df = df_deg.WT.agg.sub,
                x = df_deg.WT.agg.sub$Time_m,
                y = df_deg.WT.agg.sub$avg_int,
                color = df_deg.WT.agg.sub$HT_Conc_uM,
                shape = NULL,
                title = "HT degradation in WT cells",
                xtitle = "Time(m)",
                ytitle = "Intensity(A.U.)")
p1
```
```{r}
df_deg.WT.agg.sub2 <- df_deg.WT.agg2[df_deg.WT.agg2$Time_m <= 10,]
p2 <- pointplot(df = df_deg.WT.agg.sub2,
                x = df_deg.WT.agg.sub2$Time_m,
                y = df_deg.WT.agg.sub2$avg_int,
                color = df_deg.WT.agg.sub2$HT_Conc_uM,
                shape = df_deg.WT.agg.sub2$H_label,
                title ="HT Degradation in bright WT cells and dark WT cells",
                xtitle = "Time(m)",
                ytitle = "Intensity(A.U.)")
p2
```
Evaluate linearity with linear regression 
```{r}
#Function for linear regression 
lreg.avg <- function(df){
  reg<-c()
  r<-c()
  fitval<-c()
  summary<-c()
  ht<-c(list(unique(df$HT_Conc_uM)))
  for (i in unique(df$HT_Conc_uM)){
    data<-df[df$HT_Conc_uM == i,]
    reg<-append(reg,coef(lm(data$normed_intensity_ch2~data$Time_m))[1][1])
    sum<-summary(lm(data$normed_intensity_ch2~data$Time_m))
    r<-append(r,sum$r.squared)
    print(summary(lm(data$normed_intensity_ch2~data$Time_m)))
  }
  reg_df<-data.frame(ht,reg,r)
  colnames(reg_df)<-c("HT_conc","coefficients","r2")
  print(reg_df)
  return (reg_df)
}
```

```{r}
data <- df_deg.WT %>% filter(Time_m <=10 & H_label == "dark")

reg <- lreg.avg(data)
reg                 
```



First order reaction : ln[X]~t = -kt + ln[X]~0. Plot lnHT as a function of time
```{r}
p3 <- pointplot(df = df_deg.WT.agg,
                x = df_deg.WT.agg$Time_m,
                y = df_deg.WT.agg$ln_int,
                color = df_deg.WT.agg$HT_Conc_uM,
                shape = NULL,
                title = "lnHT as a function of time in WT cells",
                xtitle = "Time(m)",
                ytitle = "lnHT") 
  
p3
```
```{r}
p4 <- pointplot(df = df_deg.WT.agg2,
                x = df_deg.WT.agg2$Time_m,
                y = df_deg.WT.agg2$ln_int,
                color = df_deg.WT.agg2$HT_Conc_uM,
                shape = df_deg.WT.agg2$H_label,
                title = "lnHT as a function of time in bright and dark WT cells",
                xtitle = "Time(m)",
                ytitle = "lnHT") 

p4
```
```{r}
lreg1 <- function(df){
  reg<-c()
  r<-c()
  fitval<-c()
  summary<-c()
  ht<-c(list(unique(df$HT_Conc_uM)))
  for (i in unique(df$HT_Conc_uM)){
    data<-df[df$HT_Conc_uM == i,]
    reg<-append(reg,coef(lm(data$ln_int~data$Time_m))[1][1])
    sum<-summary(lm(data$ln_int~data$Time_m))
    r<-append(r,sum$r.squared)
    print(summary(lm(data$ln_int~data$Time_m)))
  }
  reg_df<-data.frame(ht,reg,r)
  colnames(reg_df)<-c("HT_conc","coefficients","r2")
  reg_df$"t1/2=ln2/k" <- log(2)/(reg_df$"coefficients")
  print(reg_df)
  return (reg_df)
}
reg1 <- lreg1(data)
```

Second order reaction - plot 1/[HT] as a function of time 

```{r}
p5 <-pointplot(df = df_deg.WT.agg,
                x = df_deg.WT.agg$Time_m,
                y = df_deg.WT.agg$rat_int,
                color = df_deg.WT.agg$HT_Conc_uM,
                shape = NULL,
                title = "1/HT as a function of time in WT cells",
                xtitle = "Time(m)",
                ytitle = "1/HT") 

p5
```
```{r}
p6 <-pointplot(df = df_deg.WT.agg2,
                x = df_deg.WT.agg2$Time_m,
                y = df_deg.WT.agg2$rat_int,
                color = df_deg.WT.agg2$HT_Conc_uM,
                shape = df_deg.WT.agg2$H_label,
                title = "1/HT as a function of time in dark and bright WT cells",
                xtitle = "Time(m)",
                ytitle = "1/HT") 

p6
```
```{r}
lreg2 <- function(df){
  reg<-c()
  r<-c()
  fitval<-c()
  summary<-c()
  ht<-c(list(unique(df$HT_Conc_uM)))
  for (i in unique(df$HT_Conc_uM)){
    data<-df[df$HT_Conc_uM == i,]
    reg<-append(reg,coef(lm(data$"1/int"~data$Time_m))[1][1])
    sum<-summary(lm(data$"1/int"~data$Time_m))
    r<-append(r,sum$r.squared)
    print(summary(lm(data$"1/int"~data$Time_m)))
  }
  reg_df<-data.frame(ht,reg,r)
  colnames(reg_df)<-c("HT_conc","coefficients","r2")
  print(reg_df)
  return (reg_df)
}
reg2 <- lreg2(data)
```
10uM HT degradation at single cell level
```{r}
lineplot <- function(df,x,y,xtitle,ytitle,title){
  png(filename = paste(title,".png") , width=600, height=900)
  p<-ggplot(df, aes(x, y)) +
        ggnewscale :: new_scale_colour() +
        geom_point(aes(color = NAME,
                       shape = Phenotype),
                   size = 3,
                   stroke = 1.5) +
        geom_line(aes(color = NAME),
                   size = 1,
                   stroke = 1) +
        labs(title = title ) +
        scale_x_continuous(name = xtitle,
                           guide = 'prism_offset_minor' ,
                           position = "bottom",
                           expand = c(0,0)) +
        scale_y_continuous(name = ytitle,
                           guide = "prism_offset_minor"
                           ) +
        theme_prism(base_size = 14)
  return(p)
}
```

```{r}
df_degt$"ln_int" <- log(df_degt$normed_intensity_ch2)
df_degt$"1/int" <- 1/df_degt$normed_intensity_ch2
df_degt1 <- df_degt[df_degt$HT_Conc_uM ==1,]
p7 <- lineplot(df = df_degt1,
               x = df_degt1$Time_m,
               y = df_degt1$normed_intensity_ch2,
               xtitle = "Time(m)",
               ytitle = "Intensity (A.U.)",
               title = "1uM HT degradation at single cell level")
p7
```
```{r}
df_degt5 <- df_degt[df_degt$HT_Conc_uM == 5,]
p8<- lineplot(df = df_degt5,
               x = df_degt5$Time_m,
               y = df_degt5$normed_intensity_ch2,
               xtitle = "Time(m)",
               ytitle = "Intensity (A.U.)",
               title = "5uM HT degradation at single cell level")
p8
```
```{r}

df_degt10 <- df_degt[df_degt$HT_Conc_uM == 10,]
p8<- lineplot(df = df_degt10,
               x = df_degt10$Time_m,
               y = df_degt10$normed_intensity_ch2,
               xtitle = "Time(m)",
               ytitle = "Intensity (A.U.)",
               title = "10uM HT degradation at single cell level")
p8
```

```{r}
datat <- df_degt %>% filter(Time_m <30 & Phenotype =="dark")
regt1 <-lreg1(datat)
regt2 <-lreg2(datat)
regt1
regt2
```
```{r}
```
```{r}

```


```{r}
```



From results of linear regressions, 1st order fits the best to HT degradation kinetics
Next, I will calculate koff for 0.5,1,3,10uM HT degradation with 1st order kinetics
```{r}

```

